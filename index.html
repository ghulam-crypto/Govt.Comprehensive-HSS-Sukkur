<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Govt. Comprehensive HSS Sukkur Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --school-green: #166534; --school-gold: #fbbf24; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        
        /* Smooth Fade Slider */
        .slide { display: none; animation: fade 1.5s; }
        .slide.active { display: block; }
        @keyframes fade { from {opacity: .4} to {opacity: 1} }
        
        /* Watermark */
        .watermark {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            opacity: 0.08; pointer-events: none; white-space: nowrap;
            font-size: 3rem; font-weight: 900; color: #166534; z-index: 0;
        }

        /* Print Specifics */
        @media print {
            body * { visibility: hidden; }
            #result-card, #result-card * { visibility: visible; }
            #result-card { position: absolute; left: 0; top: 0; width: 100%; border: none; shadow: none; }
            .no-print { display: none !important; }
            .print-header { display: block !important; }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-green-900 text-white shadow-xl sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center space-x-4 cursor-pointer" onclick="showSection('home')">
                    <div class="bg-white p-2 rounded-full shadow-lg">
                        <div class="w-12 h-12 flex items-center justify-center text-green-900 font-bold text-2xl">GC</div>
                    </div>
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold uppercase tracking-wide">Govt. Comprehensive</h1>
                        <h2 class="text-sm md:text-base text-green-200 font-semibold">Higher Secondary School Sukkur</h2>
                        <div class="text-xs text-green-300 mt-1 flex gap-3">
                            <span><i class="inline w-3 h-3" data-lucide="map-pin"></i> Board Office Road, Sukkur</span>
                            <span class="bg-green-800 px-2 rounded">SEMIS: 418050146</span>
                        </div>
                    </div>
                </div>

                <nav class="flex space-x-2 text-sm font-bold">
                    <button onclick="showSection('home')" id="nav-home" class="nav-btn bg-green-700 px-4 py-2 rounded-lg hover:bg-green-600 transition flex items-center">
                        <i data-lucide="home" class="w-4 h-4 mr-2"></i> Home
                    </button>
                    <button onclick="showSection('result')" id="nav-result" class="nav-btn px-4 py-2 rounded-lg hover:bg-green-700 transition flex items-center">
                        <i data-lucide="file-text" class="w-4 h-4 mr-2"></i> Results
                    </button>
                    <button onclick="showSection('faculty')" id="nav-faculty" class="nav-btn px-4 py-2 rounded-lg hover:bg-green-700 transition flex items-center">
                        <i data-lucide="users" class="w-4 h-4 mr-2"></i> Faculty
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-6">

        <div id="section-home" class="space-y-8 fade-in">
            
            <div class="relative w-full h-56 md:h-96 rounded-2xl overflow-hidden shadow-2xl group border-b-4 border-green-600 bg-gray-300">
                <div class="slide active w-full h-full bg-cover bg-center" style="background-image: url('https://lh3.googleusercontent.com/p/AF1QipN-zF-y5-m-k-x-j-l-g-h-t-1');"></div>
                <div class="slide w-full h-full bg-green-800 flex items-center justify-center text-white text-4xl font-bold">Campus View</div>
                <div class="slide w-full h-full bg-green-700 flex items-center justify-center text-white text-4xl font-bold">Library</div>

                <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent flex items-end p-6 md:p-10">
                    <div>
                        <h2 class="text-white text-2xl md:text-4xl font-bold mb-2">Empowering the Future of Sukkur</h2>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-600">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-12 h-12 rounded-full bg-gray-200 overflow-hidden flex items-center justify-center text-2xl">üë®‚Äçüè´</div>
                            <div>
                                <h3 class="font-bold text-lg">Senior Principal</h3>
                                <p class="text-xs text-gray-500">Message</p>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 italic">"Discipline and dedication are the keys to success. We strive to provide the best environment for our students."</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-yellow-500">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-12 h-12 rounded-full bg-gray-200 overflow-hidden flex items-center justify-center text-2xl">üè´</div>
                            <div>
                                <h3 class="font-bold text-lg">Principal</h3>
                                <p class="text-xs text-gray-500">Message</p>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 italic">"Education is the most powerful weapon which you can use to change the world. Welcome to our portal."</p>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <div class="bg-red-600 text-white p-3 font-bold flex items-center">
                        <i data-lucide="bell" class="w-5 h-5 mr-2"></i> Notice Board
                    </div>
                    <div class="p-4 h-48 overflow-y-auto" id="notification-area">
                        <p class="text-sm text-gray-500 animate-pulse">Connecting to server...</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="font-bold text-gray-800 mb-4 border-b pb-2">Today's Attendance Overview</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center relative">
                            <canvas id="teacherChart"></canvas>
                            <p class="mt-2 text-sm font-semibold text-gray-600">Teachers</p>
                        </div>
                        <div class="text-center relative">
                            <canvas id="studentChart"></canvas>
                            <p class="mt-2 text-sm font-semibold text-gray-600">Students</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="font-bold text-gray-800 mb-4 border-b pb-2">Academic Calendar</h3>
                    <iframe src="https://calendar.google.com/calendar/embed?height=300&wkst=1&bgcolor=%23ffffff&ctz=Asia%2FKarachi&src=en.pk%23holiday%40group.v.calendar.google.com&color=%230B8043" 
                            style="border-width:0" width="100%" height="245" frameborder="0" scrolling="no"></iframe>
                </div>
            </div>
        </div>

        <div id="section-result" class="hidden">
            <div id="search-container" class="max-w-xl mx-auto bg-white rounded-xl shadow-md p-6 mt-10 border-t-4 border-green-600">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Student Result Portal</h2>
                    <p class="text-gray-500 text-sm">Enter Seat Number to view result card.</p>
                </div>
                <div class="flex flex-col gap-3">
                    <input type="text" id="searchInput" 
                        class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 uppercase" placeholder="e.g. 10255">
                    <button onclick="searchStudent()" class="bg-green-700 text-white py-3 rounded-lg font-bold hover:bg-green-800 transition">
                        View Result
                    </button>
                    <p id="errorMsg" class="text-red-500 text-center text-sm hidden font-medium"></p>
                    <p id="loadingMsg" class="text-green-600 text-center text-sm hidden animate-pulse">Fetching data from database...</p>
                </div>
            </div>

            <div id="result-container" class="hidden max-w-4xl mx-auto mt-6">
                <button onclick="resetSearch()" class="mb-4 text-green-700 font-medium flex items-center hover:underline no-print">
                    <i data-lucide="arrow-left" class="w-4 h-4 mr-1"></i> Back
                </button>

                <div id="result-card" class="bg-white rounded-none md:rounded-xl shadow-lg border border-gray-300 relative overflow-hidden p-8 min-h-[600px]">
                    <div class="watermark">Govt. Comprehensive HS School</div>
                    <div class="text-center border-b-2 border-green-800 pb-4 mb-6">
                        <div class="flex justify-center items-center gap-4 mb-2">
                            <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center font-bold text-gray-500">LOGO</div>
                            <div>
                                <h1 class="text-3xl font-extrabold text-green-900 uppercase">Govt. Comprehensive</h1>
                                <h2 class="text-lg font-bold text-gray-700">Higher Secondary School Sukkur</h2>
                                <p class="text-sm text-gray-500">SEMIS CODE: 418050146</p>
                            </div>
                        </div>
                        <span class="bg-black text-white px-4 py-1 rounded text-sm font-bold uppercase tracking-widest"> Official Marks certificate</span>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-6 relative z-10">
                        <div>
                            <p class="text-gray-500 text-sm">Student Name:</p>
                            <p class="font-bold text-lg text-gray-800 border-b border-gray-300" id="rName">--</p>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">Father's Name:</p>
                            <p class="font-bold text-lg text-gray-800 border-b border-gray-300" id="rFather">--</p>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">Class / Group:</p>
                            <p class="font-bold text-gray-800" id="rClass">--</p>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">Seat Number:</p>
                            <p class="font-bold text-gray-800" id="rSeat">--</p>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">GR No:</p>
                            <p class="font-bold text-gray-800" id="rGRNo">--</p>
                        </div>
                    </div>

                    <table class="w-full border-collapse border border-gray-300 text-sm relative z-10 mb-6">
                        <thead class="bg-green-100">
                            <tr>
                                <th class="border border-gray-300 p-2 text-left">Subject</th>
                                <th class="border border-gray-300 p-2 text-right">Max Marks</th>
                                <th class="border border-gray-300 p-2 text-right">Obtained</th>
                            </tr>
                        </thead>
                        <tbody id="marksBody"></tbody>
                        <tfoot class="bg-gray-50 font-bold">
                            <tr>
                                <td class="border border-gray-300 p-2">Grand Total</td>
                                <td class="border border-gray-300 p-2 text-right" id="rMaxTotal">--</td>
                                <td class="border border-gray-300 p-2 text-right text-green-800 text-lg" id="rTotal">000</td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <div class="text-center mb-8 relative z-10">
                        <span class="text-gray-600 font-medium">Result Status: </span>
                        <span id="rResult" class="text-2xl font-bold">PASS</span>
                    </div>

                    <div class="flex justify-between items-end mt-12 relative z-10 pt-8">
                        <div class="text-center">
                            <div class="border-b border-black w-40 mb-1"></div>
                            <p class="text-xs font-bold">Class Teacher</p>
                        </div>
                        <div class="text-center">
                            <div class="border-b border-black w-40 mb-1"></div>
                            <p class="text-xs font-bold">Senior Principal</p>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-6 no-print">
                    <button onclick="window.print()" class="bg-gray-800 text-white px-8 py-3 rounded-full shadow-lg hover:bg-black transition font-bold">
                        Print Official Card
                    </button>
                </div>
            </div>
        </div>

        <div id="section-faculty" class="hidden">
            <h2 class="text-2xl font-bold text-center text-green-800 mb-6">School Faculty</h2>
            <div id="teacher-loader" class="text-center hidden text-green-600 animate-pulse">Loading Faculty Data...</div>
            <div id="teachers-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
        </div>

    </main>

    <script>
        lucide.createIcons();

        // ============================================
        //  YOUR CONNECTED BACKEND URL
        // ============================================
        const API_URL = "https://script.google.com/macros/s/AKfycbxGMBT2ioG8a1-PTfq1WUCt3SThsevPbw0IUOiSJf9Htzb0M1bQT9_4fjTggacmTJT5/exec"; 
        
        // ============================================

        let allStudents = [];
        let dashboardData = {};

        window.onload = function() {
            startSlider();
            loadDashboard();
            fetchStudents(); // Pre-load students in background
        };

        function showSection(id) {
            ['home', 'result', 'faculty'].forEach(sec => {
                document.getElementById('section-'+sec).classList.add('hidden');
                document.getElementById('nav-'+sec).classList.remove('bg-green-700');
            });
            document.getElementById('section-'+id).classList.remove('hidden');
            document.getElementById('nav-'+id).classList.add('bg-green-700');

            if(id === 'faculty') loadTeachers();
        }

        // --- 3. Carousel Logic ---
        function startSlider() {
            let slideIndex = 0;
            const slides = document.getElementsByClassName("slide");
            if(slides.length === 0) return;
            
            function showSlides() {
                for (let i = 0; i < slides.length; i++) slides[i].classList.remove('active');
                slideIndex++;
                if (slideIndex > slides.length) slideIndex = 1;
                slides[slideIndex-1].classList.add('active');
                setTimeout(showSlides, 4000);
            }
            showSlides();
        }

        // --- 4. Dashboard & Chart Logic ---
        function loadDashboard() {
            fetch(`${API_URL}?action=getDashboardStats`)
            .then(response => response.json())
            .then(json => {
                if(json.success) {
                    renderDashboard(json.data);
                }
            })
            .catch(err => console.error("Dashboard Load Error:", err));
        }

        function renderDashboard(data) {
            // Notifications
            const notifDiv = document.getElementById('notification-area');
            notifDiv.innerHTML = data.notifications.map(n => 
                `<div class="border-b py-2 text-sm text-gray-700 flex"><i data-lucide="chevron-right" class="w-4 h-4 text-green-600 mr-2"></i> ${n}</div>`
            ).join('');
            lucide.createIcons();

            // Charts
            createPieChart('teacherChart', [data.teachers.present, data.teachers.leave], ['Present', 'On Leave']);
            createPieChart('studentChart', [data.students.present, data.students.leave], ['Present', 'On Leave']);
        }

        function createPieChart(canvasId, data, labels) {
            const ctx = document.getElementById(canvasId);
            if(!ctx) return;
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#166534', '#ef4444'], 
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
        }

        // --- 5. Result Logic (Official Card) ---
        function fetchStudents() {
            // Background fetch all students
            fetch(`${API_URL}?action=getStudentData`)
            .then(res => res.json())
            .then(json => {
                if(json.success) allStudents = json.data;
            })
            .catch(err => console.error("Student Fetch Error:", err));
        }

        function searchStudent() {
            const input = document.getElementById('searchInput').value.trim();
            const errorMsg = document.getElementById('errorMsg');
            const loadingMsg = document.getElementById('loadingMsg');

            if(!input) return;

            // Simple visual loading state if data isn't ready
            if(allStudents.length === 0) {
                loadingMsg.classList.remove('hidden');
                // Try fetching again if empty
                fetch(`${API_URL}?action=getStudentData`)
                .then(res => res.json())
                .then(json => {
                    loadingMsg.classList.add('hidden');
                    if(json.success) {
                        allStudents = json.data;
                        performSearch(input); // Try search again
                    }
                });
                return;
            }

            performSearch(input);
        }

        function performSearch(input) {
            // Try to match strict, or loose equality
            const s = allStudents.find(st => String(st.SeatNo) == input);
            
            if(s) {
                document.getElementById('search-container').classList.add('hidden');
                document.getElementById('result-container').classList.remove('hidden');
                
                // Populate Standard Fields
                document.getElementById('rName').innerText = s.Name || '--';
                document.getElementById('rFather').innerText = s.FatherName || '--';
                document.getElementById('rClass').innerText = s.Class || '--';
                document.getElementById('rSeat').innerText = s.SeatNo || '--';
                document.getElementById('rTotal').innerText = s.Total || '--';
                
                // GR No Logic (Finds any column named "GRNo", "G.R.No", etc)
                const grKey = Object.keys(s).find(k => /g\.?r\.?\s*no/i.test(k)) || 'GRNo';
                document.getElementById('rGRNo').innerText = s[grKey] || '-';
                
                // Status Color
                const resDiv = document.getElementById('rResult');
                const resultTxt = s.Result || 'PASS';
                resDiv.innerText = resultTxt;
                resDiv.className = resultTxt.toLowerCase().includes('fail') ? "text-2xl font-bold text-red-600" : "text-2xl font-bold text-green-600";

                // Generate Table
                const tbody = document.getElementById('marksBody');
                tbody.innerHTML = '';
                
                const ignore = ['Name','FatherName','Class','SeatNo','Result','Total','SNo', 'Caste', 'Percentage', 'Grade', 'Position', grKey];
                
                let subjectCount = 0; 
                Object.keys(s).forEach(key => {
                    const isGrNo = /g\.?r\.?\s*no/i.test(key); 
                    // Only show keys that are not ignored and have a value
                    if(!ignore.includes(key) && !isGrNo && s[key]) {
                        subjectCount++; 
                        tbody.innerHTML += `
                            <tr>
                                <td class="border border-gray-300 p-2 capitalize">${key}</td>
                                <td class="border border-gray-300 p-2 text-right text-gray-500">100</td>
                                <td class="border border-gray-300 p-2 text-right font-bold">${s[key]}</td>
                            </tr>`;
                    }
                });
                
                document.getElementById('rMaxTotal').innerText = subjectCount * 100;

            } else {
                const errorMsg = document.getElementById('errorMsg');
                errorMsg.innerText = "Record not found. Check Seat Number.";
                errorMsg.classList.remove('hidden');
            }
        }

        function resetSearch() {
            document.getElementById('result-container').classList.add('hidden');
            document.getElementById('search-container').classList.remove('hidden');
            document.getElementById('searchInput').value = '';
            document.getElementById('errorMsg').classList.add('hidden');
        }

        // --- 6. Faculty Logic ---
        function loadTeachers() {
            const grid = document.getElementById('teachers-grid');
            if(grid.children.length > 0) return; // Already loaded

            document.getElementById('teacher-loader').classList.remove('hidden');

            fetch(`${API_URL}?action=getTeacherData`)
            .then(res => res.json())
            .then(json => {
                document.getElementById('teacher-loader').classList.add('hidden');
                if(json.success) {
                    json.data.forEach(t => {
                        grid.innerHTML += `
                            <div class="bg-white p-4 rounded shadow border-t-4 border-green-600">
                                <h3 class="font-bold text-lg">${t.Name}</h3>
                                <p class="text-sm text-green-700 font-semibold">${t.Designation}</p>
                                <p class="text-xs text-gray-500 mt-1">${t.Qualification}</p>
                            </div>
                        `;
                    });
                }
            })
            .catch(err => {
                document.getElementById('teacher-loader').innerText = "Error loading data. Check internet.";
            });
        }
    </script>
</body>
</html>
