<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Govt. Comprehensive HSS Sukkur Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --school-green: #166534; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .slide { display: none; animation: fade 1.5s; }
        .slide.active { display: block; }
        @keyframes fade { from {opacity: .4} to {opacity: 1} }
        .watermark {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            opacity: 0.08; pointer-events: none; white-space: nowrap;
            font-size: 3rem; font-weight: 900; color: #166534; z-index: 0;
        }
        @media print {
            body * { visibility: hidden; }
            #result-card, #result-card * { visibility: visible; }
            #result-card { position: absolute; left: 0; top: 0; width: 100%; border: none; shadow: none; }
            .no-print { display: none !important; }
        }
        /* Modal Styles */
        .modal { background-color: rgba(0,0,0,0.5); }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-green-900 text-white shadow-xl sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center space-x-4 cursor-pointer" onclick="showSection('home')">
                    <div class="bg-white p-2 rounded-full shadow-lg">
                        <img src="https://lh3.googleusercontent.com/d/1jnNNiAc2-DZUtVkABXetBkMGqB0olPju" class="w-12 h-12 object-contain" alt="Logo">
                    </div>
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold uppercase tracking-wide">Govt. Comprehensive</h1>
                        <h2 class="text-sm md:text-base text-green-200 font-semibold">Higher Secondary School Sukkur</h2>
                    </div>
                </div>

                <nav class="flex space-x-2 text-sm font-bold">
                    <button onclick="showSection('home')" id="nav-home" class="bg-green-700 px-4 py-2 rounded-lg hover:bg-green-600 transition flex items-center">
                        <i data-lucide="home" class="w-4 h-4 mr-2"></i> Home
                    </button>
                    <button onclick="openLoginModal()" id="nav-login" class="px-4 py-2 rounded-lg hover:bg-green-700 transition flex items-center bg-yellow-500 text-green-900">
                        <i data-lucide="log-in" class="w-4 h-4 mr-2"></i> Login Portal
                    </button>
                    <button onclick="logout()" id="nav-logout" class="hidden px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 transition flex items-center">
                        <i data-lucide="log-out" class="w-4 h-4 mr-2"></i> Logout
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-6">

        <div id="section-home" class="space-y-8 fade-in">
            <div class="relative w-full h-56 md:h-96 rounded-2xl overflow-hidden shadow-2xl group border-b-4 border-green-600">
                <img src="https://via.placeholder.com/1200x500/166534/FFFFFF?text=Welcome+to+GCHSS+Sukkur" class="slide active w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent flex items-end p-6 md:p-10">
                    <h2 class="text-white text-2xl md:text-4xl font-bold mb-2">Empowering the Future of Sukkur</h2>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="font-bold text-gray-800 mb-4 border-b pb-2">Attendance Overview</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center"><canvas id="teacherChart"></canvas><p>Teachers</p></div>
                        <div class="text-center"><canvas id="studentChart"></canvas><p>Students</p></div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <div class="bg-red-600 text-white p-3 font-bold flex items-center">
                        <i data-lucide="bell" class="w-5 h-5 mr-2"></i> Notice Board
                    </div>
                    <div class="p-4 h-48 overflow-y-auto" id="notification-area">Loading...</div>
                </div>
            </div>
        </div>

        <div id="section-student" class="hidden">
            <div id="result-card" class="bg-white rounded-xl shadow-lg border border-gray-300 relative overflow-hidden p-8 min-h-[600px] max-w-4xl mx-auto">
                <div class="watermark">Govt. Comprehensive HS School</div>
                <div class="text-center border-b-2 border-green-800 pb-4 mb-6">
                    <h1 class="text-3xl font-extrabold text-green-900 uppercase">Govt. Comprehensive HSS</h1>
                    <span class="bg-black text-white px-4 py-1 rounded text-sm font-bold uppercase">Official Marks Certificate</span>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-6 relative z-10" id="student-meta"></div>
                <table class="w-full border-collapse border border-gray-300 text-sm relative z-10 mb-6">
                    <thead class="bg-green-100">
                        <tr><th class="border p-2 text-left">Subject</th><th class="border p-2 text-right">Marks</th></tr>
                    </thead>
                    <tbody id="marksBody"></tbody>
                </table>
                <div class="text-center mt-6 no-print">
                    <button onclick="window.print()" class="bg-gray-800 text-white px-8 py-3 rounded-full shadow-lg">Print Card</button>
                </div>
            </div>
        </div>

        <div id="section-teacher" class="hidden max-w-4xl mx-auto">
            <h2 class="text-2xl font-bold text-green-800 mb-4">Teacher Dashboard</h2>
            <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                <h3 class="font-bold mb-2">Update Student Result</h3>
                <div class="flex gap-2">
                    <input type="text" id="teacher-seat-input" placeholder="Enter Seat Number" class="border p-2 rounded w-full">
                    <button onclick="teacherSearchStudent()" class="bg-blue-600 text-white p-2 rounded">Search</button>
                </div>
            </div>
            
            <div id="teacher-editor" class="hidden bg-white p-6 rounded-xl shadow-md border-t-4 border-yellow-500">
                <h3 class="font-bold text-lg mb-4">Editing: <span id="edit-student-name" class="text-blue-600"></span></h3>
                <div id="edit-fields" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
                <button onclick="saveStudentResult()" class="mt-6 bg-green-700 text-white px-6 py-2 rounded hover:bg-green-800 w-full font-bold">Save Changes</button>
            </div>
        </div>

        <div id="section-admin" class="hidden max-w-5xl mx-auto">
            <h2 class="text-2xl font-bold text-red-800 mb-4">Admin Control Panel</h2>
            
            <div class="bg-white p-6 rounded-xl shadow-md mb-8 border-l-4 border-red-600">
                <h3 class="font-bold text-lg mb-4">Manage Faculty Credentials</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input id="admin-t-id" placeholder="Teacher ID (Username)" class="border p-2 rounded">
                    <input id="admin-t-pass" placeholder="Password" class="border p-2 rounded">
                    <input id="admin-t-name" placeholder="Full Name" class="border p-2 rounded">
                    <input id="admin-t-desig" placeholder="Designation" class="border p-2 rounded">
                </div>
                <div class="flex gap-2 mt-4">
                    <button onclick="adminManageTeacher('add')" class="bg-green-600 text-white px-4 py-2 rounded">Add New Teacher</button>
                    <button onclick="adminManageTeacher('edit')" class="bg-blue-600 text-white px-4 py-2 rounded">Update Existing ID</button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-md">
                <h3 class="font-bold text-lg mb-4">Registered Teachers</h3>
                <button onclick="loadAdminTeacherList()" class="text-sm text-blue-600 underline mb-2">Refresh List</button>
                <div id="admin-teacher-list" class="overflow-x-auto"></div>
            </div>
        </div>

    </main>

    <div id="loginModal" class="fixed inset-0 modal hidden flex items-center justify-center z-[100]">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md mx-4 relative">
            <button onclick="closeLoginModal()" class="absolute top-4 right-4 text-gray-500 hover:text-red-500"><i data-lucide="x"></i></button>
            
            <h2 class="text-2xl font-bold text-center text-green-900 mb-6">Portal Login</h2>
            
            <div class="flex justify-center mb-6 bg-gray-100 p-1 rounded-lg">
                <button onclick="setLoginRole('student')" id="tab-student" class="flex-1 py-2 rounded-md font-bold text-sm bg-white shadow text-green-800">Student</button>
                <button onclick="setLoginRole('teacher')" id="tab-teacher" class="flex-1 py-2 rounded-md font-bold text-sm text-gray-500">Teacher</button>
                <button onclick="setLoginRole('admin')" id="tab-admin" class="flex-1 py-2 rounded-md font-bold text-sm text-gray-500">Admin</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1" id="lbl-user">Seat Number</label>
                    <input type="text" id="login-user" class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-green-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1" id="lbl-pass">GR Number (Password)</label>
                    <input type="password" id="login-pass" class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-green-500 outline-none">
                </div>
                <button onclick="performLogin()" id="btnLogin" class="w-full bg-green-800 text-white py-3 rounded-lg font-bold hover:bg-green-900 transition">
                    Login
                </button>
                <p id="login-msg" class="text-center text-red-500 text-sm h-4"></p>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        
        // ============================================
        //  YOUR UPDATED URL
        // ============================================
        const API_URL = "https://script.google.com/macros/s/AKfycbzED9cjIpi2DENKvayOCZYN7xqbe7nJ7Vdz7NdpYpohHMuzBmKNO6_0s4EMjUjyCCts/exec"; 
        // ============================================

        let currentRole = 'student';
        let currentUser = null; 

        window.onload = function() {
            startSlider();
            loadDashboard();
        };

        // --- NAVIGATION ---
        function showSection(id) {
            document.querySelectorAll('main > div').forEach(d => d.classList.add('hidden'));
            document.getElementById('section-'+id).classList.remove('hidden');
        }

        // --- LOGIN LOGIC ---
        function openLoginModal() { document.getElementById('loginModal').classList.remove('hidden'); }
        function closeLoginModal() { document.getElementById('loginModal').classList.add('hidden'); }
        
        function setLoginRole(role) {
            currentRole = role;
            // UI Toggle
            ['student','teacher','admin'].forEach(r => {
                document.getElementById('tab-'+r).className = (r===role) 
                    ? "flex-1 py-2 rounded-md font-bold text-sm bg-white shadow text-green-800" 
                    : "flex-1 py-2 rounded-md font-bold text-sm text-gray-500";
            });
            // Labels
            if(role === 'student') {
                document.getElementById('lbl-user').innerText = "Seat Number";
                document.getElementById('lbl-pass').innerText = "GR Number";
            } else if(role === 'teacher') {
                document.getElementById('lbl-user').innerText = "Teacher ID";
                document.getElementById('lbl-pass').innerText = "Password";
            } else {
                document.getElementById('lbl-user').innerText = "Admin Username";
                document.getElementById('lbl-pass').innerText = "Admin Password";
            }
        }

        function performLogin() {
            const user = document.getElementById('login-user').value.trim();
            const pass = document.getElementById('login-pass').value.trim();
            const btn = document.getElementById('btnLogin');
            const msg = document.getElementById('login-msg');

            if(!user || !pass) { msg.innerText = "Credentials required"; return; }

            btn.innerText = "Verifying...";
            btn.disabled = true;

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'login', role: currentRole, username: user, password: pass })
            })
            .then(res => res.json())
            .then(json => {
                btn.innerText = "Login"; btn.disabled = false;
                if(json.success) {
                    currentUser = json; // Save session
                    closeLoginModal();
                    document.getElementById('nav-login').classList.add('hidden');
                    document.getElementById('nav-logout').classList.remove('hidden');
                    
                    if(currentRole === 'student') {
                        renderStudentResult(json.data);
                        showSection('student');
                    } else if(currentRole === 'teacher') {
                        showSection('teacher');
                    } else if(currentRole === 'admin') {
                        showSection('admin');
                        loadAdminTeacherList();
                    }
                } else {
                    msg.innerText = json.message;
                }
            })
            .catch(e => { 
                console.error(e);
                btn.innerText="Login"; 
                btn.disabled=false; 
                msg.innerText="Connection Error. Check Console."; 
            });
        }

        function logout() {
            currentUser = null;
            document.getElementById('nav-login').classList.remove('hidden');
            document.getElementById('nav-logout').classList.add('hidden');
            document.getElementById('login-user').value = '';
            document.getElementById('login-pass').value = '';
            showSection('home');
        }

        // --- STUDENT RENDER ---
        function renderStudentResult(data) {
            const metaDiv = document.getElementById('student-meta');
            const body = document.getElementById('marksBody');
            
            // Meta
            metaDiv.innerHTML = `
                <div><p class="text-gray-500 text-xs">Name</p><p class="font-bold">${data.Name || '--'}</p></div>
                <div><p class="text-gray-500 text-xs">Father Name</p><p class="font-bold">${data.FatherName || '--'}</p></div>
                <div><p class="text-gray-500 text-xs">Seat No</p><p class="font-bold">${data.SeatNo || '--'}</p></div>
                <div><p class="text-gray-500 text-xs">Class</p><p class="font-bold">${data.Class || '--'}</p></div>
            `;

            // Marks
            body.innerHTML = '';
            const ignore = ['Name','FatherName','Class','SeatNo','Result','Total','SNo', 'GrNo', 'GRNo', 'Caste', 'Percentage', 'Grade', 'Position'];
            
            Object.keys(data).forEach(key => {
                if(!ignore.includes(key) && data[key]) {
                     body.innerHTML += `<tr><td class="border p-2 capitalize">${key}</td><td class="border p-2 text-right font-bold">${data[key]}</td></tr>`;
                }
            });
        }

        // --- TEACHER LOGIC ---
        let editingSeatNo = null;

        function teacherSearchStudent() {
            const seat = document.getElementById('teacher-seat-input').value;
            if(!seat) return;
            
            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'getStudentResult', seatNo: seat })
            })
            .then(res => res.json())
            .then(json => {
                if(json.success) {
                    const s = json.data;
                    editingSeatNo = s.SeatNo;
                    document.getElementById('teacher-editor').classList.remove('hidden');
                    document.getElementById('edit-student-name').innerText = `${s.Name} (${s.SeatNo})`;
                    
                    const container = document.getElementById('edit-fields');
                    container.innerHTML = '';
                    
                    const ignore = ['Name','FatherName','Class','SeatNo','SNo', 'GrNo', 'GRNo'];
                    Object.keys(s).forEach(key => {
                        if(!ignore.includes(key)) {
                            container.innerHTML += `
                                <div>
                                    <label class="text-xs font-bold text-gray-500">${key}</label>
                                    <input type="text" data-subject="${key}" value="${s[key]}" class="w-full border p-2 rounded">
                                </div>
                            `;
                        }
                    });

                } else {
                    alert('Student not found');
                }
            });
        }

        function saveStudentResult() {
            const inputs = document.querySelectorAll('#edit-fields input');
            let updates = {};
            inputs.forEach(inp => {
                updates[inp.getAttribute('data-subject')] = inp.value;
            });

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ 
                    action: 'updateStudentResult', 
                    seatNo: editingSeatNo, 
                    updates: updates 
                })
            })
            .then(res => res.json())
            .then(json => {
                alert(json.message);
                if(json.success) document.getElementById('teacher-editor').classList.add('hidden');
            });
        }

        // --- ADMIN LOGIC ---
        function adminManageTeacher(mode) {
            const id = document.getElementById('admin-t-id').value;
            const pass = document.getElementById('admin-t-pass').value;
            const name = document.getElementById('admin-t-name').value;
            const desig = document.getElementById('admin-t-desig').value;

            if(!id || !pass) { alert("ID and Password Required"); return; }

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ 
                    action: 'adminUpdateTeacher', 
                    mode: mode,
                    teacherID: id, password: pass, name: name, designation: desig
                })
            })
            .then(res => res.json())
            .then(json => {
                alert(json.message);
                if(json.success) loadAdminTeacherList();
            });
        }

        function loadAdminTeacherList() {
            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'adminGetTeachers' })
            })
            .then(res => res.json())
            .then(json => {
                const list = document.getElementById('admin-teacher-list');
                if(json.success) {
                    list.innerHTML = `<table class="w-full text-sm text-left"><tr class="bg-gray-100"><th>ID</th><th>Pass</th><th>Name</th><th>Desig</th></tr>` 
                    + json.data.map(t => `<tr><td class="p-2 border">${t.TeacherID}</td><td class="p-2 border">${t.Password}</td><td class="p-2 border">${t.Name}</td><td class="p-2 border">${t.Designation}</td></tr>`).join('') 
                    + `</table>`;
                }
            });
        }

        // --- DASHBOARD (Existing) ---
        function startSlider() {
            let slideIndex = 0;
            const slides = document.getElementsByClassName("slide");
            if(slides.length === 0) return;
            function showSlides() {
                for (let i = 0; i < slides.length; i++) slides[i].classList.remove('active');
                slideIndex++;
                if (slideIndex > slides.length) slideIndex = 1;
                slides[slideIndex-1].classList.add('active');
                setTimeout(showSlides, 4000);
            }
            showSlides();
        }

        function loadDashboard() {
            fetch(`${API_URL}?action=getDashboardStats`)
            .then(res => res.json())
            .then(json => {
                 if(json.success) {
                    document.getElementById('notification-area').innerHTML = json.data.notifications.map(n => `<div class="border-b py-2 text-sm"><i data-lucide="chevron-right" class="w-4 inline"></i> ${n}</div>`).join('');
                    createPieChart('teacherChart', [json.data.teachers.present, json.data.teachers.leave]);
                    createPieChart('studentChart', [json.data.students.present, json.data.students.leave]);
                }
            })
            .catch(e => console.log("Dashboard fetch error (likely CORS or Script not public)"));
        }

        function createPieChart(id, data) {
            const ctx = document.getElementById(id);
            if(!ctx) return;
            new Chart(ctx, { type: 'doughnut', data: { labels: ['Present', 'Leave'], datasets: [{ data: data, backgroundColor: ['#166534', '#ef4444'] }] } });
        }
    </script>
</body>
</html>
